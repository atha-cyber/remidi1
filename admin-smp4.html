<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel CBT - SMP 4 Pandak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .active-tab { background-color: #eff6ff; color: #2563eb; border-left: 4px solid #2563eb; font-weight: bold; }
        .tab-btn:hover { background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="loginView" class="fixed inset-0 bg-slate-800 z-[300] flex flex-col items-center justify-center p-6">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-inner">
                <i class="fas fa-user-shield"></i>
            </div>
            <h1 class="text-xl font-black text-slate-800 mb-1 uppercase tracking-tighter">Admin Access</h1>
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-8">SMP Negeri 4 Pandak</p>
            <input type="password" id="adminPassword" class="w-full p-4 border-2 rounded-xl mb-4 text-center text-2xl tracking-[0.5em] focus:border-blue-500 outline-none transition font-bold" placeholder="••••">
            <button onclick="window.checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg transition-all active:scale-95 uppercase tracking-widest text-xs">Otorisasi</button>
        </div>
    </div>

    <div id="mainDashboard" class="hidden flex h-full">
        <aside class="w-64 bg-white border-r shadow-sm flex flex-col shrink-0">
            <div class="p-6 border-b flex flex-col items-center">
                <img src="https://i.ibb.co.com/DfC8xNjL/LOGO-HD-SMP-4-removebg-preview.png" alt="Logo" class="h-14 mb-3">
                <h2 class="font-black text-slate-800 tracking-tight text-center leading-tight text-sm">CBT CONTROL<br><span class="text-[9px] text-blue-600 uppercase font-bold tracking-widest">Administrator</span></h2>
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scroll">
                <button onclick="window.switchTab('general')" id="tab-general" class="tab-btn active-tab w-full p-3 rounded-lg flex items-center gap-3 transition-colors text-[11px] font-bold uppercase tracking-wider">
                    <i class="fas fa-sliders-h w-4"></i> Konfigurasi
                </button>
                <button onclick="window.switchTab('subjects')" id="tab-subjects" class="tab-btn w-full p-3 rounded-lg flex items-center gap-3 transition-colors text-[11px] font-bold uppercase tracking-wider">
                    <i class="fas fa-layer-group w-4"></i> Bank Soal
                </button>
                <button onclick="window.switchTab('results')" id="tab-results" class="tab-btn w-full p-3 rounded-lg flex items-center gap-3 transition-colors text-[11px] font-bold uppercase tracking-wider">
                    <i class="fas fa-poll w-4"></i> Rekap Nilai
                </button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="location.reload()" class="w-full p-3 text-red-500 hover:bg-red-50 rounded-lg flex items-center gap-3 transition-colors text-[10px] font-bold uppercase">
                    <i class="fas fa-power-off"></i> Keluar Sistem
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-slate-50">
            <header class="h-16 bg-white border-b flex items-center justify-between px-8 shrink-0">
                <h2 id="currentTabTitle" class="font-black text-slate-700 uppercase tracking-widest text-xs">Konfigurasi Sistem</h2>
                <div id="saveStatus" class="text-green-600 font-bold text-[9px] uppercase opacity-0 transition-opacity flex items-center gap-2 bg-green-50 px-3 py-1.5 rounded-full border border-green-100">
                    <i class="fas fa-check-circle"></i> Sinkronisasi Cloud Berhasil
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 custom-scroll">
                <section id="generalSection" class="fade-in max-w-3xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border flex items-center justify-between">
                            <div><h4 class="font-bold text-slate-800 text-xs uppercase">Mode Paksa</h4><p class="text-[9px] text-gray-400">Abaikan jadwal ujian</p></div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleForceMode" class="sr-only peer" onchange="window.updateSettings()">
                                <div class="w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                            </label>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border flex items-center justify-between">
                            <div><h4 class="font-bold text-slate-800 text-xs uppercase">Anti-Curang</h4><p class="text-[9px] text-gray-400">Deteksi pindah tab</p></div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleAntiCheat" class="sr-only peer" onchange="window.updateSettings()">
                                <div class="w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border mb-8">
                        <h4 class="font-black text-slate-800 text-[10px] uppercase tracking-widest mb-6 border-b pb-4"><i class="fas fa-map-marked-alt mr-2 text-red-500"></i>Geofencing (Kunci Lokasi)</h4>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-[9px] font-bold text-gray-400 uppercase mb-2">Latitude Sekolah</label><input type="number" id="inputLat" step="any" class="w-full p-3 bg-slate-50 border rounded-xl text-xs font-bold" onchange="window.updateSettings()"></div>
                            <div><label class="block text-[9px] font-bold text-gray-400 uppercase mb-2">Longitude Sekolah</label><input type="number" id="inputLng" step="any" class="w-full p-3 bg-slate-50 border rounded-xl text-xs font-bold" onchange="window.updateSettings()"></div>
                        </div>
                        <div class="flex gap-4 items-end">
                            <div class="flex-1"><label class="block text-[9px] font-bold text-gray-400 uppercase mb-2">Radius Izin (Meter)</label><input type="number" id="inputRadius" class="w-full p-3 bg-slate-50 border rounded-xl text-xs font-bold" onchange="window.updateSettings()"></div>
                            <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-300">
                                <span class="text-[9px] font-bold text-slate-500 uppercase">Aktifkan GPS:</span>
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="toggleGeoCheck" class="sr-only peer" onchange="window.updateSettings()"><div class="w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-red-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div></label>
                            </div>
                        </div>
                        <button onclick="window.testMyLocation()" class="mt-4 w-full py-2 border-2 border-blue-600 text-blue-600 rounded-xl text-[10px] font-bold uppercase hover:bg-blue-600 hover:text-white transition-all"><i class="fas fa-crosshairs mr-2"></i>Uji Lokasi Saya Sekarang</button>
                        <div id="testResult" class="mt-3 p-3 rounded-lg text-[10px] font-bold hidden text-center italic"></div>
                    </div>
                </section>

                <section id="resultsSection" class="fade-in hidden">
                    <div class="flex justify-between items-center mb-6 text-xs font-bold">
                        <h4 class="uppercase tracking-widest text-slate-800">Respon Siswa Terbaru</h4>
                        <button onclick="window.exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg uppercase shadow-lg shadow-green-100">Export CSV</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <table class="w-full text-left text-[11px]">
                            <thead class="bg-slate-50 border-b text-slate-400 font-bold uppercase">
                                <tr>
                                    <th class="p-4">Timestamp</th>
                                    <th class="p-4">Nama Siswa</th>
                                    <th class="p-4 text-center">Kelas/Absen</th>
                                    <th class="p-4">Mapel</th>
                                    <th class="p-4 text-center">Skor</th>
                                    <th class="p-4 text-center">Logs</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable" class="divide-y"></tbody>
                        </table>
                    </div>
                </section>

                <section id="subjectsSection" class="fade-in hidden">
                    <button onclick="window.showAddModal()" class="mb-8 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold text-[10px] uppercase shadow-xl shadow-blue-100 hover:scale-105 transition-transform"><i class="fas fa-plus-circle mr-2"></i>Daftar Mapel Baru</button>
                    <div id="subjectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>
            </div>
        </main>
    </div>

    <div id="subjectModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[400] hidden flex items-center justify-center p-6 text-xs">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-xl overflow-hidden">
            <div class="bg-slate-800 p-5 text-white flex justify-between items-center">
                <h3 id="modalTitle" class="font-black uppercase tracking-widest">Manajemen Mata Pelajaran</h3>
                <button onclick="window.closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <input type="hidden" id="editIdx">
                <div><label class="block font-bold text-slate-400 uppercase mb-1">Nama Mapel</label><input type="text" id="subjName" class="w-full p-3 bg-slate-50 border rounded-xl uppercase"></div>
                <div><label class="block font-bold text-slate-400 uppercase mb-1">Link Drive Soal</label><input type="text" id="subjUrl" class="w-full p-3 bg-slate-50 border rounded-xl"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block font-bold text-slate-400 uppercase mb-1">Mulai</label><input type="datetime-local" id="subjStart" class="w-full p-3 bg-slate-50 border rounded-xl"></div>
                    <div><label class="block font-bold text-slate-400 uppercase mb-1">Selesai</label><input type="datetime-local" id="subjEnd" class="w-full p-3 bg-slate-50 border rounded-xl"></div>
                </div>
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-1"><label class="block font-bold text-slate-400 uppercase mb-1">Jml Soal</label><input type="number" id="subjCount" class="w-full p-3 bg-slate-50 border rounded-xl text-center"></div>
                    <div class="col-span-3"><label class="block font-bold text-slate-400 uppercase mb-1">Kunci Jawaban</label><input type="text" id="subjKey" class="w-full p-3 bg-slate-50 border rounded-xl font-mono tracking-widest uppercase"></div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="window.closeModal()" class="flex-1 py-3 text-slate-400 font-bold uppercase">Batal</button>
                    <button onclick="window.saveSubject()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // MENGGUNAKAN TARGET SUNTIKAN %% UNTUK VERCEL
        const firebaseConfig = {
            apiKey: "%%VERCEL_FIREBASE_API_KEY%%",
            authDomain: "%%VERCEL_FIREBASE_AUTH_DOMAIN%%",
            projectId: "%%VERCEL_FIREBASE_PROJECT_ID%%",
            storageBucket: "%%VERCEL_FIREBASE_STORAGE_BUCKET%%",
            messagingSenderId: "%%VERCEL_FIREBASE_MESSAGING_SENDER_ID%%",
            appId: "%%VERCEL_FIREBASE_APP_ID%%"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const CONFIG_DOC = 'cbt_apps/settings_v2';
        const RES_COLL = 'cbt_results';
        
        // TARGET SUNTIKAN PASSWORD
        const ADMIN_PASSWORD = "%%VERCEL_ADMIN_PASSWORD%%";

        let subjects = [], resultsData = [];
        let schoolLat = -7.927, schoolLng = 110.2978, allowedRadius = 300;

        window.checkLogin = () => {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                init();
            } else {
                alert("AKSES DITOLAK!");
                document.getElementById('adminPassword').value = '';
            }
        };

        async function init() {
            await signInAnonymously(auth);
            onSnapshot(doc(db, CONFIG_DOC), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    subjects = d.subjects || [];
                    document.getElementById('toggleForceMode').checked = d.forcedMode || false;
                    document.getElementById('toggleAntiCheat').checked = d.antiCheatEnabled !== false;
                    document.getElementById('toggleGeoCheck').checked = d.geoCheckEnabled || false;
                    document.getElementById('inputLat').value = d.schoolLat || schoolLat;
                    document.getElementById('inputLng').value = d.schoolLng || schoolLng;
                    document.getElementById('inputRadius').value = d.allowedRadius || allowedRadius;
                    window.renderAdminTabs();
                }
            });

            onSnapshot(query(collection(db, RES_COLL), orderBy('time', 'desc'), limit(150)), (snap) => {
                resultsData = [];
                const table = document.getElementById('resultsTable'); table.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data(); resultsData.push(d);
                    table.innerHTML += `<tr class="hover:bg-slate-50">
                        <td class="p-4 font-mono text-[9px] text-gray-400">${d.time}</td>
                        <td class="p-4 font-bold text-slate-700 uppercase">${d.name}</td>
                        <td class="p-4 text-center font-bold text-blue-600">${d.class}/${d.noAbsen}</td>
                        <td class="p-4 font-bold text-slate-500 uppercase text-[9px]">${d.mapel}</td>
                        <td class="p-4 text-center"><span class="bg-slate-800 text-white px-2 py-1 rounded font-black">${d.score}</span></td>
                        <td class="p-4 text-center font-bold ${d.violations > 0 ? 'text-red-500' : 'text-gray-200'}"><i class="fas fa-user-secret"></i> ${d.violations}</td>
                    </tr>`;
                });
            });
        }

        window.updateSettings = async () => {
            await setDoc(doc(db, CONFIG_DOC), {
                subjects,
                forcedMode: document.getElementById('toggleForceMode').checked,
                antiCheatEnabled: document.getElementById('toggleAntiCheat').checked,
                geoCheckEnabled: document.getElementById('toggleGeoCheck').checked,
                schoolLat: parseFloat(document.getElementById('inputLat').value),
                schoolLng: parseFloat(document.getElementById('inputLng').value),
                allowedRadius: parseInt(document.getElementById('inputRadius').value)
            }, { merge: true });
            showSaved();
        };

        window.renderAdminTabs = () => {
            const grid = document.getElementById('subjectGrid'); grid.innerHTML = '';
            subjects.forEach((s, i) => {
                grid.innerHTML += `<div class="bg-white p-5 rounded-2xl border shadow-sm relative group">
                    <div class="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-all scale-75">
                        <button onclick="window.editSubject(${i})" class="w-8 h-8 bg-blue-50 text-blue-600 rounded-full"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteSubject(${i})" class="w-8 h-8 bg-red-50 text-red-600 rounded-full"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <h4 class="font-bold text-slate-800 uppercase text-[11px] mb-1 truncate pr-16">${s.name}</h4>
                    <p class="text-[9px] text-gray-400 font-bold mb-4 uppercase">${s.qCount} Soal</p>
                    <div class="pt-4 border-t grid grid-cols-2 gap-2 text-[8px] font-bold text-gray-400 uppercase">
                        <div>Start: <span class="block text-slate-600">${s.start || '-'}</span></div>
                        <div>End: <span class="block text-slate-600">${s.end || '-'}</span></div>
                    </div>
                </div>`;
            });
        };

        window.saveSubject = async () => {
            const name = document.getElementById('subjName').value.trim();
            const url = document.getElementById('subjUrl').value.trim();
            const idx = document.getElementById('editIdx').value;
            if(!name || !url) return alert("LENGKAPI DATA!");
            const obj = { 
                name, url, 
                start: document.getElementById('subjStart').value, 
                end: document.getElementById('subjEnd').value, 
                key: document.getElementById('subjKey').value.toUpperCase().replace(/\s/g, ''), 
                qCount: parseInt(document.getElementById('subjCount').value) || 40,
                isActive: true
            };
            if (idx === "") subjects.push(obj); else subjects[idx] = obj;
            await setDoc(doc(db, CONFIG_DOC), { subjects }, { merge: true });
            window.closeModal(); showSaved();
        };

        window.deleteSubject = async (idx) => {
            if(confirm("Hapus mapel?")) { subjects.splice(idx, 1); await setDoc(doc(db, CONFIG_DOC), { subjects }, { merge: true }); showSaved(); }
        };

        window.editSubject = (idx) => {
            const s = subjects[idx]; document.getElementById('editIdx').value = idx;
            document.getElementById('subjName').value = s.name; document.getElementById('subjUrl').value = s.url;
            document.getElementById('subjStart').value = s.start || ''; document.getElementById('subjEnd').value = s.end || '';
            document.getElementById('subjKey').value = s.key || ''; document.getElementById('subjCount').value = s.qCount || 40;
            document.getElementById('subjectModal').classList.remove('hidden');
        };

        window.switchTab = (tab) => {
            ['general','subjects','results'].forEach(t => {
                document.getElementById(`${t}Section`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active-tab');
            });
            document.getElementById(`${tab}Section`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
        };

        window.showAddModal = () => { 
            document.getElementById('editIdx').value = ""; document.getElementById('subjName').value = ""; 
            document.getElementById('subjectModal').classList.remove('hidden'); 
        };
        window.closeModal = () => document.getElementById('subjectModal').classList.add('hidden');
        function showSaved() { const s = document.getElementById('saveStatus'); s.style.opacity = '1'; setTimeout(() => s.style.opacity = '0', 2000); }
        
        window.testMyLocation = () => {
            const res = document.getElementById('testResult'); res.classList.remove('hidden'); res.innerHTML = "Mencari GPS...";
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat2 = parseFloat(document.getElementById('inputLat').value), lon2 = parseFloat(document.getElementById('inputLng').value);
                const R = 6371e3, φ1 = pos.coords.latitude * Math.PI/180, φ2 = lat2 * Math.PI/180, Δφ = (lat2-pos.coords.latitude) * Math.PI/180, Δλ = (lon2-pos.coords.longitude) * Math.PI/180;
                const a = Math.sin(Δφ/2)**2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2)**2;
                const d = Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
                res.innerHTML = `Jarak: ${d} Meter. Status: ${d <= parseInt(document.getElementById('inputRadius').value) ? 'AMAN' : 'DILUAR RADIUS'}`;
            }, (err) => alert(err.message));
        };

        window.exportToExcel = () => {
            let csv = 'Timestamp,Nama,Kelas,Absen,Mapel,Skor\n';
            resultsData.forEach(r => csv += `${r.time},${r.name},${r.class},${r.noAbsen},${r.mapel},${r.score}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Rekap.csv'; a.click();
        };
    </script>
</body>
</html>
